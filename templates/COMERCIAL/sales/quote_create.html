{% extends 'base.html' %}
{% load static %}

{% block title %} Cotizaciones {% endblock title %}
{% block main %} Cotizaciones {% endblock main %}
{% block appName %} Nuevo {% endblock appName %}

{% block panel-content %}
<div class="container mt-4">
    <h4>Crear Nueva Cotización</h4>
    
    <form id="quote-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Formulario principal de la cotización -->
        <div class="card mb-4">
            <div class="card-header pb-0">
                <h5>Información de cotización</h5>
            </div>
            <div class="card-body pt-0">
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label" for="{{ form.idClient.id_for_label }}">Cliente</label>
                            {{ form.idClient }}
                        </div>
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label" for="{{ form.idTinReceiving.id_for_label }}">Empresa Receptora</label>
                            {{ form.idTinReceiving }}
                        </div>
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label" for="{{ form.idTinExecuting.id_for_label }}">Empresa Ejecutora</label>
                            {{ form.idTinExecuting }}
                        </div>
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label" for="{{ form.shortDescription.id_for_label }}">Descripción corta</label>
                            {{ form.shortDescription }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label" for="{{ form.currency.id_for_label }}">Moneda</label>
                            {{ form.currency }}
                        </div>
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label" for="{{ form.dateOrder.id_for_label }}">Fecha de Solicitud</label>
                            {{ form.dateOrder }}
                        </div>
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label" for="{{ form.deadline.id_for_label }}">Fecha de Entrega</label>
                            {{ form.deadline }}
                        </div>
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label" for="{{ form.payMethod.id_for_label }}">Método de Pago</label>
                            {{ form.payMethod }}
                        </div>
                        <div class="form-check">
                            {{ form.isPO }}
                            <label class="form-check-label" for="{{ form.isPO.id_for_label }}">Es PO?</label>
                        </div>
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label" for="{{ form.poNumber.id_for_label }}">Número de PO</label>
                            {{ form.poNumber }}
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario para agregar items -->
        <div class="card mb-4">
            <div class="card-header pb-0">
                <h5>Plantilla de Transformadores</h5>
            </div>
            <div class="card-body pt-0">
                <!-- Fila 1: Tipo de Transformador -->
                <div class="row">
                    <h6> Tipo y serie de  transformador</h6>
                    <div class="col-md-3">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">Phase</label>
                            <select id="id_phase" class="form-control">
                                <option value="">Seleccionar</option>
                                <option value="0">Single-phase</option>
                                <option value="1">Three-phase</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">Cooling</label>
                            <select id="id_cooling" class="form-control">
                                <option value="">Seleccionar</option>
                                <option value="0">ONAN</option>
                                <option value="1">ONAF</option>
                                <option value="2">KNAN</option>
                                <option value="3">KNAF</option>
                                <option value="4">AN</option>
                                <option value="5">AF</option>
                                <option value="6">OFAN</option>
                                <option value="7">OFAF</option>
                                <option value="8">ONWF</option>
                                <option value="9">OFWF</option>
                                <option value="10">KNAN/KNAF</option>
                                <option value="11">OFWONAN/ONAFF</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">Mounting</label>
                            <select id="id_mounting" class="form-control">
                                <option value="">Seleccionar</option>
                                <option value="0">Pole</option>
                                <option value="1">Pad</option>
                                <option value="2">Platform</option>
                                <option value="3">Underground</option>
                                <option value="4">Substation</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">Serial</label>
                            <input type="text" id="id_seq" class="form-control" placeholder="Ej: TRF-001">
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">Documento de plano/dibujo</label>
                            <input type="file" id="id_drawing_file" name="drawing_file" class="form-control" accept=".pdf,.dwg,.dxf,.jpg,.png">
                        </div>
                        <small class="text-muted">Formatos aceptados: PDF, DWG, DXF, JPG, PNG</small>
                    </div>

                </div>

                <!-- Fila 2: Características Eléctricas -->
                <div class="row">
                    <h6 class="mt-2 mb-0"> Características técnicas</h6>
                    <div class="col-md-2">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">KVA</label>
                            <select id="id_kva" class="form-control">
                                <option value="">Seleccionar</option>
                                <option value="0">75</option>
                                <option value="1">100</option>
                                <option value="2">150</option>
                                <option value="3">167</option>
                                <option value="4">225</option>
                                <option value="5">250</option>
                                <option value="6">300</option>
                                <option value="7">500</option>
                                <option value="8">750</option>
                                <option value="9">1000</option>
                                <option value="10">1500</option>
                                <option value="11">2000</option>
                                <option value="12">2000/3000</option>
                                <option value="13">2500</option>
                                <option value="14">2600</option>
                                <option value="15">3000</option>
                                <option value="16">3000/3750</option>
                                <option value="17">3750</option>
                                <option value="18">5000</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">HV</label>
                            <select id="id_hv" class="form-control">
                                <option value="">Seleccionar</option>
                                <option value="0">4160</option>
                                <option value="1">7200</option>
                                <option value="2">8320</option>
                                <option value="3">12470</option>
                                <option value="4">13200</option>
                                <option value="5">13800</option>
                                <option value="6">14400</option>
                                <option value="7">21600</option>
                                <option value="8">22860</option>
                                <option value="9">23960</option>
                                <option value="10">24940</option>
                                <option value="11">34500</option>
                                <option value="12">2400Delta X 7200Delta X 4160GY/2400 X 12470GY/7200</option>
                                <option value="13">12470 X 24940</option>
                                <option value="14">14400 X 7200</option>
                                <option value="15">34500 GrdY/19920</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">LV</label>
                            <select id="id_lv" class="form-control">
                                <option value="">Seleccionar</option>
                                <option value="0">240/120</option>
                                <option value="1">480Y/277</option>
                                <option value="2">208Y/120</option>
                                <option value="3">4160Y/2400</option>
                                <option value="4">277/480Y</option>
                                <option value="5">277</option>
                                <option value="6">480</option>
                                <option value="7">208</option>
                                <option value="8">480/240</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">Frequency</label>
                            <select id="id_hz" class="form-control">
                                <option value="">Seleccionar</option>
                                <option value="0">50 Hz</option>
                                <option value="1">60 Hz</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">Winding</label>
                            <select id="id_winding" class="form-control">
                                <option value="">Seleccionar</option>
                                <option value="0">Al</option>
                                <option value="1">Cu</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">Connection</label>
                            <select id="id_connection" class="form-control">
                                <option value="">Seleccionar</option>
                                <option value="0">Dyn1</option>
                                <option value="1">Dyn11</option>
                                <option value="2">Yyn0</option>
                                <option value="3">YNyn0</option>
                                <option value="4">Dzn0</option>
                                <option value="5">Yd11</option>
                                <option value="6">lio</option>
                                <option value="7">Dyn1/YNyn0</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Fila 3: Standard y Costos -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">Standard</label>
                            <select id="id_standard" class="form-control">
                                <option value="">Seleccionar</option>
                                <option value="0">IEEE C57.12.00</option>
                                <option value="1">IEEE C57.12.20</option>
                                <option value="2">IEEE C57.12.21</option>
                                <option value="3">IEEE C57.12.34</option>
                                <option value="4">IEEE C57.12.38</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">Cantidad</label>
                            <input type="number" id="id_quantity" class="form-control" min="1" value="1">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group input-group-outline my-3 is-focused">
                            <label class="form-label">Costo Unitario</label>
                            <input type="number" id="id_unit_cost" class="form-control" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group my-3">
                            <button type="button" id="add-item" class="btn bg-gradient-dark btn-block">Agregar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de productos agregados -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Items en la Cotización</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="items-table">
                        <thead>
                            <tr>
                                <th>Descripción</th>
                                <th>Serial</th>
                                <th>KVA</th>
                                <th>Cantidad</th>
                                <th>Costo Unit.</th>
                                <th>Subtotal</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="items-tbody">
                            <!-- Los items se agregarán aquí dinámicamente -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" class="text-right"><strong>Total:</strong></td>
                                <td><strong id="total-amount">0.00</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Campo oculto para enviar los datos de los items -->
        <input type="hidden" name="items_data" id="items-data">

        <div class="form-group">
            <button type="submit" class="btn bg-gradient-success">Crear Cotización</button>
            <a href="{% url 'ventas_app:cotizaciones-lista' %}" class="btn bg-gradient-secondary">Cancelar</a>
        </div>
    </form>
</div>

{% endblock panel-content %}

{% block JSscripts %}
<script>
// Usar jQuery en modo compatibilidad
jQuery(document).ready(function($) {
    var items = [];
    var itemCounter = 0;
    var drawingFiles = {}; // Almacenar archivos temporalmente

    // Mapeo de valores a textos para mostrar
    const PHASE_MAP = {'0': 'SP', '1': 'TP'};
    const COOLING_MAP = {'0': 'ONAN', '1': 'ONAF', '2': 'KNAN', '3': 'KNAF', '4': 'AN', '5': 'AF', '6': 'OFAN', '7': 'OFAF', '8': 'ONWF', '9': 'OFWF'};
    const MOUNTING_MAP = {'0': 'Pole', '1': 'Pad', '2': 'Platform', '3': 'Underground', '4': 'Substation'};
    const KVA_MAP = {'0': '75', '1': '100', '2': '150', '3': '167', '4': '225', '5': '250', '6': '300', '7': '500', '8': '750', '9': '1000', '10': '1500', '11': '2000', '12': '2000/3000', '13': '2500', '14': '2600', '15': '3000', '16': '3000/3750', '17': '3750', '18': '5000'};

    // Función para agregar item a la tabla
    $('#add-item').on('click', function() {
        // Obtener todos los valores
        var phase = $('#id_phase').val();
        var cooling = $('#id_cooling').val();
        var mounting = $('#id_mounting').val();
        var seq = $('#id_seq').val().trim();
        var kva = $('#id_kva').val();
        var hv = $('#id_hv').val();
        var lv = $('#id_lv').val();
        var hz = $('#id_hz').val();
        var winding = $('#id_winding').val();
        var connection = $('#id_connection').val();
        var standard = $('#id_standard').val();
        var quantity = parseInt($('#id_quantity').val());
        var unitCost = parseFloat($('#id_unit_cost').val());
        var drawingFileInput = $('#id_drawing_file')[0];
        var drawingFile = drawingFileInput.files[0];
        
        // Validación
        if (!phase || !cooling || !mounting || !kva || !hv || !lv || !hz || !winding || !connection || !standard) {
            alert('Por favor complete todos los campos técnicos del transformador');
            return;
        }
        
        if (!seq) {
            alert('Por favor ingrese un número de serial');
            return;
        }
        
        if (isNaN(quantity) || quantity <= 0) {
            alert('Por favor ingrese una cantidad válida');
            return;
        }
        
        if (isNaN(unitCost) || unitCost <= 0) {
            alert('Por favor ingrese un costo unitario válido');
            return;
        }
        
        // Crear descripción del transformador
        var description = `${PHASE_MAP[phase]} ${COOLING_MAP[cooling]} ${MOUNTING_MAP[mounting]} ${KVA_MAP[kva]}kVA`;
        
        // Si hay archivo, almacenarlo temporalmente
        var fileId = 'drawing_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        if (drawingFile) {
            drawingFiles[fileId] = drawingFile;
        }
        
        // Agregar item al array
        var item = {
            id: itemCounter++,
            description: description,
            seq: seq,
            phase: phase,
            cooling: cooling,
            mounting: mounting,
            kva: kva,
            hv: hv,
            lv: lv,
            hz: hz,
            winding: winding,
            connection: connection,
            standard: standard,
            quantity: quantity,
            unit_cost: unitCost,
            subtotal: quantity * unitCost,
            drawing_file_id: drawingFile ? fileId : null,
            drawing_file_name: drawingFile ? drawingFile.name : ''
        };
        
        items.push(item);
        
        // Actualizar tabla
        updateTable();
        
        // Limpiar formulario
        clearItemForm();
    });

    // Función para limpiar el formulario de items
    function clearItemForm() {
        $('#id_phase').val('');
        $('#id_cooling').val('');
        $('#id_mounting').val('');
        $('#id_seq').val('');
        $('#id_kva').val('');
        $('#id_hv').val('');
        $('#id_lv').val('');
        $('#id_hz').val('');
        $('#id_winding').val('');
        $('#id_connection').val('');
        $('#id_standard').val('');
        $('#id_quantity').val('1');
        $('#id_unit_cost').val('');
        $('#id_drawing_file').val(''); // Limpiar input de archivo
        $('#id_phase').focus();
    }

    // Función para actualizar la tabla y el total
    function updateTable() {
        var tbody = $('#items-tbody');
        var totalAmountElement = $('#total-amount');
        var itemsDataElement = $('#items-data');
        
        // Limpiar tabla
        tbody.empty();
        
        var totalAmount = 0;
        
        // Llenar tabla
        $.each(items, function(index, item) {
            var row = $('<tr></tr>');
            row.append($('<td></td>').text(item.description));
            row.append($('<td></td>').text(item.seq));
            row.append($('<td></td>').text(KVA_MAP[item.kva]));
            row.append($('<td></td>').text(item.quantity));
            row.append($('<td></td>').text('$' + item.unit_cost.toFixed(2)));
            row.append($('<td></td>').text('$' + item.subtotal.toFixed(2)));
            
            var removeButton = $('<button type="button" class="btn btn-danger btn-sm">Eliminar</button>');
            removeButton.on('click', function() {
                removeItem(item.id);
            });
            
            var actionsTd = $('<td></td>').append(removeButton);
            row.append(actionsTd);
            
            tbody.append(row);
            
            totalAmount += item.subtotal;
        });
        
        // Actualizar total
        totalAmountElement.text('$' + totalAmount.toFixed(2));
        
        // Actualizar campo oculto con datos JSON
        var itemsData = [];
        $.each(items, function(index, item) {
            var itemData = {
                phase: item.phase,
                cooling: item.cooling,
                mounting: item.mounting,
                seq: item.seq,
                kva: item.kva,
                hv: item.hv,
                lv: item.lv,
                hz: item.hz,
                winding: item.winding,
                connection: item.connection,
                standard: item.standard,
                quantity: item.quantity,
                unit_cost: item.unit_cost,
                drawing_file_name: item.drawing_file_name
            };
            itemsData.push(itemData);
        });
        
        itemsDataElement.val(JSON.stringify(itemsData));
    }

    // Función para eliminar item
    function removeItem(itemId) {
        var itemToRemove = items.find(item => item.id === itemId);
        if (itemToRemove && itemToRemove.drawing_file_id) {
            delete drawingFiles[itemToRemove.drawing_file_id];
        }
        
        items = items.filter(function(item) {
            return item.id !== itemId;
        });
        updateTable();
    }

    // Función para enviar el formulario con AJAX
    function submitFormWithAjax(form) {
        var formData = new FormData(form);
        
        // Agregar los archivos de dibujo al FormData
        $.each(drawingFiles, function(fileId, file) {
            formData.append(fileId, file);
        });
        
        // Agregar metadata de archivos
        var filesMetadata = {};
        $.each(items, function(index, item) {
            if (item.drawing_file_id) {
                filesMetadata[item.drawing_file_id] = {
                    item_index: index,
                    file_name: item.drawing_file_name
                };
            }
        });
        formData.append('files_metadata', JSON.stringify(filesMetadata));
        
        // Mostrar loader
        $('button[type="submit"]').prop('disabled', true).html('Guardando... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
        
        $.ajax({
            url: form.action,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    window.location.href = response.redirect_url || "{% url 'ventas_app:cotizaciones-lista' %}";
                } else {
                    alert('Error: ' + response.error);
                    $('button[type="submit"]').prop('disabled', false).html('Crear Cotización');
                }
            },
            error: function(xhr) {
                var errorMessage = 'Error al crear la cotización';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage += ': ' + xhr.responseJSON.error;
                }
                alert(errorMessage);
                $('button[type="submit"]').prop('disabled', false).html('Crear Cotización');
            }
        });
    }

    // Validación y envío del formulario
    $('#quote-form').on('submit', function(e) {
        e.preventDefault();
        
        if (items.length === 0) {
            alert('Debe agregar al menos un transformador a la cotización');
            return false;
        }
        
        // Validar campos requeridos del formulario principal
        var valid = true;
        var requiredFields = [
            '#id_idClient',
            '#id_idTinReceiving', 
            '#id_idTinExecuting',
            '#id_currency',
            '#id_dateOrder',
            '#id_deadline',
            '#id_payMethod'
        ];
        
        $.each(requiredFields, function(index, fieldId) {
            var field = $(fieldId);
            if (field.length > 0 && !field.val()) {
                valid = false;
                field.addClass('is-invalid');
            }
        });
        
        if (!valid) {
            alert('Por favor complete todos los campos requeridos de la cotización');
            return false;
        }
        
        // Enviar formulario con AJAX
        submitFormWithAjax(this);
    });

    // Limpiar validación cuando se modifique un campo
    $('select, input').on('change', function() {
        $(this).removeClass('is-invalid');
    });
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Establecer la empresa receptora por defecto
        var tinReceivingField = document.getElementById("id_idTinReceiving");
        if (tinReceivingField) {
            tinReceivingField.value = "{{user.company.id}}";
        }
    });
</script>
{% endblock JSscripts %}