{% extends 'COMERCIAL/sales/base-quotes.html' %}
{% load static %}

{% block title %} Cotizaciones {% endblock title %}
{% block main %} Cotizaciones {% endblock main %}
{% block appName %} Nuevo {% endblock appName %}

{% block panel-content %}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Crear Nueva Cotización **** </h3>
                </div>
                <form method="post" id="quoteForm">
                    {% csrf_token %}
                    <div class="card-body">
                        <!-- Información básica de la cotización -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>{{ form.idClient.label }}</label>
                                    {{ form.idClient }}
                                </div>
                                <div class="form-group">
                                    <label>{{ form.shortDescription.label }}</label>
                                    {{ form.shortDescription }}
                                </div>
                                <div class="form-group">
                                    <label>{{ form.currency.label }}</label>
                                    {{ form.currency }}
                                </div>
                                <div class="form-group">
                                    <label>{{ form.dateOrder.label }}</label>
                                    {{ form.dateOrder }}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>{{ form.idTinReceiving.label }}</label>
                                    {{ form.idTinReceiving }}
                                </div>
                                <div class="form-group">
                                    <label>{{ form.idTinExecuting.label }}</label>
                                    {{ form.idTinExecuting }}
                                </div>
                                <div class="form-group">
                                    <label>{{ form.payMethod.label }}</label>
                                    {{ form.payMethod }}
                                </div>
                                <div class="form-group">
                                    <label>{{ form.deadline.label }}</label>
                                    {{ form.deadline }}
                                </div>
                                <div class="form-check">
                                    {{ form.isPO }}
                                    <label class="form-check-label">{{ form.isPO.label }}</label>
                                </div>
                            </div>

                        </div>

                        <!-- Tabla de productos -->
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <h4>Productos de la Cotización</h4>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="productsTable">
                                        <thead>
                                            <tr>
                                                <th>Transformador</th>
                                                <th>Especificaciones</th>
                                                <th>Cantidad</th>
                                                <th>Costo Unitario</th>
                                                <th>Subtotal</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="productsBody">
                                            <!-- Las filas se agregarán dinámicamente -->
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="4" class="text-right"><strong>Total:</strong></td>
                                                <td><strong id="totalAmount">0.00</strong></td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <button type="button" class="btn btn-primary" id="addProductBtn">
                                    <i class="fas fa-plus"></i> Añadir Producto
                                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="submit" class="btn btn-success">Crear Cotización</button>
                        <a href="{% url 'quotes:quote_list' %}" class="btn btn-secondary">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock panel-content %}

{% block JSscripts %}

<script>
let rowCount = 0;

// Template para una nueva fila de producto
function getProductRow() {
    rowCount++;
    return `
    <tr id="row-${rowCount}">
        <td>
            <select name="trafo" class="form-control trafo-select" data-row="${rowCount}" required>
                <option value="">Seleccionar Trafo</option>
                {% for trafo in trafos %}
                <option value="{{ trafo.id }}">{{ trafo }}</option>
                {% endfor %}
            </select>
        </td>
        <td class="specs-${rowCount}"></td>
        <td>
            <input type="number" name="quantity" class="form-control quantity-input" 
                   data-row="${rowCount}" min="1" value="1" required>
        </td>
        <td>
            <input type="number" name="unit_cost" class="form-control unit-cost-input" 
                   data-row="${rowCount}" step="0.01" min="0" value="0.00" required>
        </td>
        <td class="subtotal-${rowCount}">0.00</td>
        <td>
            <button type="button" class="btn btn-danger btn-sm remove-row" data-row="${rowCount}">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
    `;
}

// Calcular subtotal y total
function calculateTotals() {
    let total = 0;
    
    $('.trafo-select').each(function() {
        const row = $(this).data('row');
        const quantity = $(`input.quantity-input[data-row="${row}"]`).val() || 0;
        const unitCost = $(`input.unit-cost-input[data-row="${row}"]`).val() || 0;
        const subtotal = quantity * unitCost;
        
        $(`.subtotal-${row}`).text(subtotal.toFixed(2));
        total += subtotal;
    });
    
    $('#totalAmount').text(total.toFixed(2));
}

// Obtener detalles del trafo
function getTrafoDetails(trafoId, row) {
    if (trafoId) {
        $.ajax({
            url: '/quotes/get-trafo-details/' + trafoId + '/',
            method: 'GET',
            success: function(data) {
                if (!data.error) {
                    $(`.specs-${row}`).html(
                        `${data.kva} kVA - ${data.type} - ${data.mounting} - ${data.cooling}`
                    );
                }
            }
        });
    }
}

// Preparar datos antes del envío del formulario
function prepareFormData() {
    const items = [];
    $('.trafo-select').each(function() {
        const row = $(this).data('row');
        const trafoId = $(this).val();
        const quantity = $(`input.quantity-input[data-row="${row}"]`).val();
        const unitCost = $(`input.unit-cost-input[data-row="${row}"]`).val();
        
        if (trafoId && quantity && unitCost) {
            items.push(`${trafoId}|${quantity}|${unitCost}`);
        }
    });
    
    // Agregar campo hidden con los items
    $('#quoteForm').append('<input type="hidden" name="items[]" value="' + items.join(',') + '">');
}

// Eventos
$(document).ready(function() {
    // Añadir primera fila
    $('#productsBody').append(getProductRow());
    
    // Añadir nueva fila
    $('#addProductBtn').click(function() {
        $('#productsBody').append(getProductRow());
    });
    
    // Eliminar fila
    $(document).on('click', '.remove-row', function() {
        const row = $(this).data('row');
        $(`#row-${row}`).remove();
        calculateTotals();
    });
    
    // Cambio en selección de trafo
    $(document).on('change', '.trafo-select', function() {
        const trafoId = $(this).val();
        const row = $(this).data('row');
        getTrafoDetails(trafoId, row);
    });
    
    // Cambio en cantidad o costo
    $(document).on('input', '.quantity-input, .unit-cost-input', function() {
        calculateTotals();
    });
    
    // Preparar datos antes de enviar el formulario
    $('#quoteForm').submit(function() {
        prepareFormData();
        return true;
    });
});
</script>

<script>
    document.getElementById("id_idTinReceiving").value = "{{user.company.id}}";
</script>

{% endblock JSscripts %}