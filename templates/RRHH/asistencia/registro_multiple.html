<!-- templates/RRHH/asistencia/registro_multiple.html -->
{% extends "base.html" %}
{% load static %}

{% block navbar_main %}Mi espacio{% endblock %}
{% block navbar_appName %}Mis asistencias{% endblock %}
{% block navbar_Type %}Registrar Horas Extra{% endblock %}

{% block panel-content %}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-2"></i>
                        Registro Multiple de Asistencia
                    </h5>
                    <button type="button" class="btn btn-primary btn-sm" id="btnAgregarFila">
                        <i class="fas fa-plus me-1"></i>Agregar Fila
                    </button>
                </div>
                <div class="card-body pt-0">
                    {% if empleado %}
                    <div class="alert alert-info mb-4 text-white">
                        <strong>Nombre:</strong> {{ empleado|default:"-" }}
                    </div>
                    {% endif %}

                    <form method="post" id="registroForm">
                        {% csrf_token %}
                        {{ formset.management_form }}

                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="tablaRegistros">
                                <thead class="table-light">
                                    <tr>
                                        <th width="12%">Fecha</th>
                                        <th width="12%">Hora Inicio</th>
                                        <th width="12%">Hora Final</th>
                                        <th width="12%">Local</th>
                                        <th width="20%">Observaciones</th>
                                        <th width="16%">Jornada Horaria</th>
                                        <th width="16%">Jornada Diaria</th>
                                        <th width="5%">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="formset-body">
                                    {% for form in formset %}
                                    <tr class="registro-fila">
                                        <td>
                                            {{ form.id }}
                                            {{ form.fecha }}
                                        </td>
                                        <td>{{ form.hora_inicio }}</td>
                                        <td>{{ form.hora_final }}</td>
                                        <td>{{ form.idLocal }}</td>
                                        <td>{{ form.observaciones }}</td>
                                        <td>
                                            <span class="jornada-horaria-display badge bg-secondary" data-jornada="0">-</span>
                                        </td>
                                        <td>
                                            <span class="jornada-diaria-display badge bg-secondary" data-jornada="0">-</span>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-danger btn-sm btn-eliminar" {% if forloop.first and formset.total_form_count == 1 %}style="display: none;"{% endif %}>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% if form.errors %}
                                    <tr class="error-row">
                                        <td colspan="8">
                                            <div class="alert alert-danger py-2">
                                                {% for field in form %}
                                                    {% if field.errors %}
                                                        <strong>{{ field.label }}:</strong>
                                                        {{ field.errors|striptags }}
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <p class="mb-0">Tipos de jornada</p>
                        <ul>
                            <li>Jornada regular de 9:00 a 18:00</li>
                            <li>Horas extra 1 (HE1) de 18:01 a 22:00</li>
                            <li>Horas extra 2 (HE2) de 22:00 a 00:00 ó 00:00 a 06:00</li>
                        </ul>

                        <div class="mt-4">
                            <button type="submit" class="btn bg-gradient-success">
                                <i class="fas fa-save me-2"></i>Guardar Registros
                            </button>
                            <a href="{% url 'rrhh_app:asistencia-user-list' %}" class="btn bg-gradient-dark">
                                <i class="fas fa-arrow-left me-2"></i>Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template para nuevas filas - CORREGIDO -->
<template id="fila-template">
    <tr class="registro-fila">
        <td>
            <input type="hidden" name="registros-__prefix__-id" id="id_registros-__prefix__-id">
            <input type="date" name="registros-__prefix__-fecha" id="id_registros-__prefix__-fecha" class="form-control fecha-input datetimepicker flatpickr-input" required>
        </td>
        <td>
            <input type="time" name="registros-__prefix__-hora_inicio" id="id_registros-__prefix__-hora_inicio" class="form-control hora-inicio">
        </td>
        <td>
            <input type="time" name="registros-__prefix__-hora_final" id="id_registros-__prefix__-hora_final" class="form-control hora-final">
        </td>
        <td>
            <select name="registros-__prefix__-idLocal" id="id_registros-__prefix__-idLocal" class="form-control" required>
                <option value="">---------</option>
                {% for choice in formset.empty_form.idLocal.field.choices %}
                    {% if choice.0 %}
                    <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </td>
        <td>
            <textarea name="registros-__prefix__-observaciones" id="id_registros-__prefix__-observaciones" class="form-control" rows="2" placeholder="Observaciones"></textarea>
        </td>
        <td>
            <span class="jornada-horaria-display badge bg-gradient-secondary" data-jornada="0">-</span>
        </td>
        <td>
            <span class="jornada-diaria-display badge bg-gradient-secondary" data-jornada="0">-</span>
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm btn-eliminar">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</template>

{% endblock panel-content %}

{% block JSscripts %}

<script>
// Datos de feriados desde Django
const feriados = {{ feriados|safe }};
const feriadosDates = feriados;

// Función para determinar jornada horaria según hora
function determinarJornadaHoraria(horaStr) {
    if (!horaStr) return { tipo: 'No definida', codigo: '0', clase: 'bg-gradient-secondary' };
    
    const [horas, minutos] = horaStr.split(':').map(Number);
    const tiempoMinutos = horas * 60 + minutos;
    
    const INICIO_REGULAR = 9 * 60;
    const FIN_REGULAR = 18 * 60;
    const FIN_HEXTRA1 = 21 * 60;
    const FIN_HEXTRA2_NOCHE = 6 * 60;
    
    if (INICIO_REGULAR <= tiempoMinutos && tiempoMinutos <= FIN_REGULAR) {
        return { tipo: 'Regular', codigo: '0', clase: 'bg-gradient-success' };
    } else if (FIN_REGULAR < tiempoMinutos && tiempoMinutos <= FIN_HEXTRA1) {
        return { tipo: 'Extra 1', codigo: '1', clase: 'bg-gradient-warning' };
    } else if (tiempoMinutos > FIN_HEXTRA1 || tiempoMinutos <= FIN_HEXTRA2_NOCHE) {
        return { tipo: 'Extra 2/Noche', codigo: '2', clase: 'bg-gradient-danger' };
    } else {
        return { tipo: 'Especial', codigo: '0', clase: 'bg-info' };
    }
}

// Función para determinar jornada diaria según fecha
function determinarJornadaDiaria(fechaStr) {
    if (!fechaStr) return { tipo: 'No definida', codigo: '0', clase: 'bg-gradient-secondary' };
    
    const fecha = new Date(fechaStr + 'T00:00:00');
    const diaSemana = fecha.getDay();
    
    if (feriadosDates.includes(fechaStr)) {
        return { tipo: 'Feriado', codigo: '1', clase: 'bg-danger' };
    }
    
    if (diaSemana === 0 || diaSemana === 6) {
        return { tipo: 'Fin de semana', codigo: '2', clase: 'bg-warning' };
    }
    
    return { tipo: 'Laborable', codigo: '0', clase: 'bg-success' };
}

// Función para actualizar ambas jornadas
function actualizarJornadas(elemento) {
    const fila = elemento.closest('.registro-fila');
    if (!fila) return;
    
    const fechaInput = fila.querySelector('.fecha-input, input[type="date"]');
    const horaInicioInput = fila.querySelector('.hora-inicio, input[type="time"]');
    const jornadaHorariaDisplay = fila.querySelector('.jornada-horaria-display');
    const jornadaDiariaDisplay = fila.querySelector('.jornada-diaria-display');
    
    if (fechaInput && jornadaDiariaDisplay) {
        const jornadaDiaria = determinarJornadaDiaria(fechaInput.value);
        jornadaDiariaDisplay.textContent = jornadaDiaria.tipo;
        jornadaDiariaDisplay.className = `jornada-diaria-display badge ${jornadaDiaria.clase}`;
        jornadaDiariaDisplay.setAttribute('data-jornada', jornadaDiaria.codigo);
    }
    
    if (horaInicioInput && jornadaHorariaDisplay) {
        const jornadaHoraria = determinarJornadaHoraria(horaInicioInput.value);
        jornadaHorariaDisplay.textContent = jornadaHoraria.tipo;
        jornadaHorariaDisplay.className = `jornada-horaria-display badge ${jornadaHoraria.clase}`;
        jornadaHorariaDisplay.setAttribute('data-jornada', jornadaHoraria.codigo);
    }
    
    verificarAprobacion(fila);
}

// Función para verificar si requiere aprobación
function verificarAprobacion(fila) {
    const jornadaHorariaDisplay = fila.querySelector('.jornada-horaria-display');
    const jornadaDiariaDisplay = fila.querySelector('.jornada-diaria-display');
    
    if (jornadaHorariaDisplay && jornadaDiariaDisplay) {
        const esHorarioRegular = jornadaHorariaDisplay.getAttribute('data-jornada') === '0';
        const esDiaLaborable = jornadaDiariaDisplay.getAttribute('data-jornada') === '0';
        
        const requiereAprobacion = !(esDiaLaborable && esHorarioRegular);
        
        if (requiereAprobacion) {
            fila.classList.add('table-warning');
            fila.title = 'Requiere aprobación';
        } else {
            fila.classList.remove('table-warning');
            fila.title = 'No requiere aprobación - Procesado automáticamente';
        }
    }
}

// Configurar eventos para una fila
function configurarEventosFila(fila) {
    const fechaInput = fila.querySelector('.fecha-input, input[type="date"]');
    const horaInicioInput = fila.querySelector('.hora-inicio, input[type="time"]');
    
    if (fechaInput) {
        fechaInput.addEventListener('change', function() {
            actualizarJornadas(this);
        });
    }
    
    if (horaInicioInput) {
        horaInicioInput.addEventListener('change', function() {
            actualizarJornadas(this);
        });
    }
    
    // Actualizar al cargar
    if (fechaInput && fechaInput.value) {
        actualizarJornadas(fechaInput);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const formsetBody = document.getElementById('formset-body');
    const managementForm = document.getElementById('id_registros-TOTAL_FORMS');
    const btnAgregarFila = document.getElementById('btnAgregarFila');
    const filaTemplate = document.getElementById('fila-template');
    let totalForms = parseInt(managementForm.value);

    // Agregar nueva fila
    btnAgregarFila.addEventListener('click', function() {
        const templateContent = filaTemplate.content || filaTemplate;
        const newFila = templateContent.cloneNode(true);
        
        // Si es un DocumentFragment (template moderno)
        if (newFila instanceof DocumentFragment) {
            const tr = newFila.querySelector('tr');
            const html = tr.innerHTML.replace(/__prefix__/g, totalForms);
            tr.innerHTML = html;
            formsetBody.appendChild(newFila);
        } else {
            // Fallback para navegadores antiguos
            const newFilaHtml = filaTemplate.innerHTML.replace(/__prefix__/g, totalForms);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newFilaHtml;
            const tr = tempDiv.querySelector('tr');
            formsetBody.appendChild(tr);
        }
        
        const ultimaFila = formsetBody.lastElementChild;
        configurarEventosFila(ultimaFila);
        
        totalForms++;
        managementForm.value = totalForms;
        
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.style.display = 'inline-block';
        });
    });

    // Eliminar fila
    formsetBody.addEventListener('click', function(e) {
        if (e.target.closest('.btn-eliminar')) {
            const fila = e.target.closest('.registro-fila');
            const totalFilas = document.querySelectorAll('.registro-fila').length;
            
            if (totalFilas > 1) {
                fila.remove();
                totalForms--;
                managementForm.value = totalForms;
                
                if (totalForms === 1) {
                    const ultimoBoton = document.querySelector('.btn-eliminar');
                    if (ultimoBoton) ultimoBoton.style.display = 'none';
                }
            }
        }
    });

    // Configurar eventos para filas existentes
    document.querySelectorAll('.registro-fila').forEach(configurarEventosFila);
});
</script>

<style>
.jornada-horaria-display,
.jornada-diaria-display {
    font-size: 0.8em;
    padding: 0.3em 0.5em;
    display: block;
    text-align: center;
    margin-bottom: 2px;
}

.table-warning {
    background-color: #fff3cd !important;
}

.registro-fila:hover {
    background-color: #f8f9fa;
}
</style>

<script src="{% static 'assets/js/plugins/flatpickr.min.js' %}"></script>

<script>
    // Configuración del datepicker para rango de fechas
  if (document.querySelector('.datetimepicker')) {
      flatpickr('.datetimepicker', {
          allowInput: true,
          dateFormat: "Y-m-d",
      });
  }
</script>

{% endblock JSscripts %}